# 节目编辑器后端接口规范

## 概述

本文档定义了节目编辑器前端与后端之间的接口规范，包括API接口、数据模型、错误处理等内容。后端需要实现这些接口以支持可视化节目编辑功能。

### 技术架构

- **前端**：Next.js + TypeScript + Fabric.js
- **后端**：微服务架构（core-service, file-service, program-domain）
- **认证**：OAuth2 + Cookie（通过网关统一处理）
- **数据格式**：JSON（前端） ↔ VSN XML（设备播放）

### 核心设计原则

1. **双数据模型**：EditorState（前端编辑）+ VSNData（设备播放）
2. **素材引用管理**：统一的素材引用和验证机制
3. **版本管理**：草稿版本 + 正式版本的生命周期管理
4. **严格验证**：VSN格式的严格验证确保设备可播放

---

## 数据模型定义

### 核心数据结构

#### ProgramSaveData - 节目保存数据
```typescript
interface ProgramSaveData {
  // 基础信息
  id?: string;
  name: string;
  description?: string;
  width: number;           // 节目宽度
  height: number;          // 节目高度
  
  // 版本信息
  version: string;         // 版本号，如 "1.0.0"
  status: 'draft' | 'published'; // 状态
  
  // 时间信息
  createdAt?: string;      // 创建时间 ISO 8601
  updatedAt?: string;      // 更新时间 ISO 8601
  publishedAt?: string;    // 发布时间 ISO 8601
  
  // 用户信息
  createdBy: string;       // 创建者ID
  updatedBy: string;       // 最后更新者ID
  
  // 核心数据
  vsnData: VSNData;        // VSN格式数据（用于设备播放）
  editorState: EditorState; // 前端编辑状态（用于重新编辑）
  materialRefs: MaterialReference[]; // 素材引用列表
  
  // 元数据
  metadata: {
    totalDuration: number; // 总播放时长（毫秒）
    pageCount: number;     // 页面数量
    objectCount: number;   // 对象总数
    fileSize: number;      // 预估文件大小（字节）
  };
}
```

#### EditorState - 前端编辑状态
```typescript
interface EditorState {
  // 节目基础信息
  program: {
    id?: string;
    name: string;
    width: number;         // 数值类型，便于计算
    height: number;
  };
  
  // 页面管理
  pages: EditorPage[];
  currentPageIndex: number;
  
  // 画布状态（每页独立）
  canvasStates: Record<string, CanvasState>;
}

interface EditorPage {
  id: string;
  name: string;
  duration: number;        // 毫秒，数值类型
  loopType: 0 | 1;        // 0=指定时长，1=自动计算
  bgColor: string;        // #000000 格式
  bgFile?: EditorBgFile;  // 背景文件
  regions: EditorRegion[];
}

interface EditorRegion {
  id: string;
  name: string;
  rect: {
    x: number;            // 数值坐标
    y: number;
    width: number;
    height: number;
    borderWidth: number;
  };
  items: EditorItem[];
  isScheduleRegion: boolean;
  layer?: number;
}

interface EditorItem {
  id: string;
  type: number;           // VSN素材类型：2=图片,3=视频,4=单行文本等
  name?: string;
  
  // Fabric.js位置信息
  position: { x: number; y: number };
  size: { width: number; height: number };
  
  // 类型特定属性
  properties: ItemProperties;
  
  // 素材引用
  materialRef?: MaterialReference;
  
  // Fabric.js序列化数据
  fabricData?: any;       // Fabric.js对象的完整状态
}

interface CanvasState {
  objects: SerializedFabricObject[];
  zoom: number;
  panX: number;
  panY: number;
}

interface SerializedFabricObject {
  id: string;
  type: string;           // 'image', 'text', 'rect' 等
  fabricProperties: any;  // Fabric.js的toObject()结果
  editorProperties: ItemProperties;
  materialRef?: MaterialReference;
}
```

#### VSNData - VSN格式数据
```typescript
interface VSNData {
  information: {
    width: string;        // 注意：VSN格式要求String类型
    height: string;
  };
  pages: VSNPage[];
  programId?: string;
  isBucketProgram?: boolean;
}

interface VSNPage {
  loopType: string;       // "0" | "1"
  appointDuration: string; // 毫秒字符串
  bgColor: string;        // 8位十六进制整数字符串
  bgFile?: VSNBgFile;
  bgAudios?: VSNBgAudio[];
  regions: VSNRegion[];
}

interface VSNRegion {
  name: string;
  isScheduleRegion: string; // "0" | "1"
  layer?: string;
  rect: {
    x: string;
    y: string;
    width: string;
    height: string;
    borderWidth: string;
  };
  items: VSNItem[];
  buckets?: VSNBucket[];
}

interface VSNItem {
  type: string;           // "2", "3", "4", "5" 等
  name?: string;
  backColor?: string;     // 8位十六进制整数字符串
  
  // 根据type的不同，包含不同的属性
  // 图片 (type="2")
  fileSource?: VSNFileSource;
  alpha?: string;         // Float字符串
  duration?: string;      // Long字符串
  reserveAS?: string;     // "0" | "1"
  
  // 文本 (type="4"|"5")
  text?: string;
  textColor?: string;     // 8位十六进制整数字符串
  logFont?: VSNLogFont;
  isScroll?: string;      // "0" | "1"
  centeralAlign?: string; // "0"|"1"|"2"
  
  // 其他类型的特定属性...
  ineffect?: VSNEffect;
  schedule?: VSNSchedule;
}

interface VSNFileSource {
  isRelative: string;     // "0" | "1"
  filePath: string;
  md5?: string;          // 32位MD5字符串
  originName?: string;
  convertPath?: string;
}

interface VSNLogFont {
  lfHeight: string;       // 必填！Float字符串
  lfWeight?: string;      // "400" | "700"
  lfItalic?: string;      // "0" | "1"
  lfUnderline?: string;   // "0" | "1"
  lfFaceName?: string;
}
```

#### MaterialReference - 素材引用
```typescript
interface MaterialReference {
  materialId: string;     // 素材ID
  materialName: string;   // 素材名称
  materialType: number;   // 素材类型：2=图片,3=视频等
  category: string;       // 分类：'image','video','text'等
  
  // 文件信息
  filePath: string;       // 相对路径
  accessUrl: string;      // 完整访问URL
  md5Hash: string;        // 文件MD5
  originName: string;     // 原始文件名
  
  // 元数据
  fileSize: number;       // 文件大小（字节）
  dimensions?: {          // 图片/视频尺寸
    width: number;
    height: number;
  };
  duration?: number;      // 视频/音频时长（毫秒）
  format?: string;        // 文件格式
  
  // 引用信息
  isRelative: boolean;    // 是否相对路径
  convertPath?: string;   // 转换后路径（如有）
}
```

#### MaterialInfo - 素材信息
```typescript
interface MaterialInfo {
  id: string;
  name: string;
  type: number;           // VSN素材类型
  category: string;       // 分类标识
  
  // 文件信息
  filePath: string;
  accessUrl: string;      // 可直接访问的URL
  md5Hash: string;
  originName: string;
  fileSize: number;
  
  // 元数据
  metadata: {
    format: string;       // 文件格式
    dimensions?: { width: number; height: number };
    duration?: number;    // 毫秒
    bitrate?: number;     // 比特率
    fps?: number;         // 帧率（视频）
  };
  
  // 管理信息
  createdAt: string;      // ISO 8601
  updatedAt: string;
  createdBy: string;
  tags?: string[];        // 标签
  description?: string;   // 描述
  
  // 状态信息
  status: 'processing' | 'ready' | 'error'; // 处理状态
  processingProgress?: number; // 处理进度 0-100
  errorMessage?: string;  // 错误信息
}
```

---

## API接口规范

### 通用响应格式

```typescript
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;         // 错误代码
    message: string;      // 用户友好的错误信息
    details?: any;        // 详细错误信息
    field?: string;       // 字段相关错误
  };
  meta?: {
    total?: number;       // 分页总数
    page?: number;        // 当前页
    pageSize?: number;    // 页大小
    timestamp: string;    // 响应时间戳
  };
}

interface PaginationParams {
  page?: number;          // 页码，从1开始
  pageSize?: number;      // 页大小，默认20
  sortBy?: string;        // 排序字段
  sortOrder?: 'asc' | 'desc'; // 排序方向
}
```

### 1. 素材管理API

#### 1.1 获取素材分类列表
```http
GET /core/api/materials/categories
```

**响应：**
```typescript
interface MaterialCategory {
  key: string;            // 'image', 'video', 'text' 等
  label: string;          // '图片', '视频', '文本'
  description: string;    // 分类描述
  supportedTypes: number[]; // 支持的VSN类型：[2,3,6]
  icon?: string;          // 图标名称
  count: number;          // 该分类下的素材数量
}

ApiResponse<MaterialCategory[]>
```

#### 1.2 获取素材列表
```http
GET /core/api/materials
```

**查询参数：**
```typescript
interface MaterialListParams extends PaginationParams {
  category?: string;      // 分类过滤
  type?: number;          // 素材类型过滤
  search?: string;        // 搜索关键词
  tags?: string[];        // 标签过滤
  status?: string;        // 状态过滤
}
```

**响应：**
```typescript
ApiResponse<{
  items: MaterialInfo[];
  categories: MaterialCategory[]; // 包含分类统计
}>
```

#### 1.3 获取素材详情
```http
GET /core/api/materials/{materialId}
```

**响应：**
```typescript
ApiResponse<MaterialInfo>
```

#### 1.4 上传素材
```http
POST /core/api/materials/upload
Content-Type: multipart/form-data
```

**请求参数：**
```typescript
interface MaterialUploadParams {
  file: File;             // 文件
  name?: string;          // 自定义名称
  category: string;       // 分类
  tags?: string[];        // 标签
  description?: string;   // 描述
}
```

**响应：**
```typescript
ApiResponse<{
  materialId: string;
  uploadProgress?: number; // 上传进度
  processingStatus: 'pending' | 'processing' | 'completed' | 'failed';
}>
```

#### 1.5 批量验证素材引用
```http
POST /core/api/materials/validate-refs
```

**请求体：**
```typescript
interface ValidateMaterialRefsRequest {
  materialRefs: MaterialReference[];
}
```

**响应：**
```typescript
interface MaterialRefValidationResult {
  materialId: string;
  isValid: boolean;
  currentUrl?: string;    // 当前有效的访问URL
  currentMd5?: string;    // 当前文件MD5
  error?: string;         // 验证失败原因
}

ApiResponse<{
  results: MaterialRefValidationResult[];
  invalidCount: number;
  validCount: number;
}>
```

### 2. 节目管理API

#### 2.1 创建新节目草稿
```http
POST /core/api/programs/drafts
```

**请求体：**
```typescript
interface CreateProgramDraftRequest {
  name: string;
  description?: string;
  width: number;          // 节目尺寸
  height: number;
  templateId?: string;    // 基于模板创建（可选）
}
```

**响应：**
```typescript
ApiResponse<{
  programId: string;
  version: string;        // 初始版本号
  status: 'draft';
}>
```

#### 2.2 保存节目编辑状态
```http
PUT /core/api/programs/drafts/{programId}
```

**请求体：**
```typescript
interface SaveProgramRequest {
  editorState: EditorState;
  materialRefs: MaterialReference[];
  autoSave?: boolean;     // 是否自动保存
}
```

**响应：**
```typescript
ApiResponse<{
  programId: string;
  version: string;        // 更新后的版本号
  savedAt: string;        // 保存时间
  vsnValidation: {        // VSN验证结果
    isValid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
  };
}>
```

#### 2.3 加载节目编辑状态
```http
GET /core/api/programs/drafts/{programId}
```

**响应：**
```typescript
ApiResponse<ProgramSaveData>
```

#### 2.4 转换为VSN格式（预览）
```http
POST /core/api/programs/drafts/{programId}/convert-vsn
```

**请求体：**
```typescript
interface ConvertToVSNRequest {
  editorState: EditorState;
  validateOnly?: boolean; // 仅验证不保存
}
```

**响应：**
```typescript
ApiResponse<{
  vsnData: VSNData;
  vsnXml?: string;        // VSN XML字符串（如果不是仅验证）
  validation: {
    isValid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
    missingMaterials: string[]; // 缺失的素材ID列表
  };
}>
```

#### 2.5 发布节目（草稿→正式）
```http
POST /core/api/programs/drafts/{programId}/publish
```

**请求体：**
```typescript
interface PublishProgramRequest {
  publishNote?: string;   // 发布说明
  scheduleAt?: string;    // 定时发布时间（ISO 8601）
}
```

**响应：**
```typescript
ApiResponse<{
  programId: string;
  publishedVersion: string;
  publishedAt: string;
  vsnFileUrl: string;     // VSN文件下载URL
}>
```

#### 2.6 获取节目列表
```http
GET /core/api/programs
```

**查询参数：**
```typescript
interface ProgramListParams extends PaginationParams {
  status?: 'draft' | 'published' | 'all';
  createdBy?: string;     // 创建者过滤
  search?: string;        // 搜索关键词
  dateFrom?: string;      // 创建日期范围
  dateTo?: string;
}
```

**响应：**
```typescript
interface ProgramListItem {
  id: string;
  name: string;
  description?: string;
  status: 'draft' | 'published';
  version: string;
  
  // 时间信息
  createdAt: string;
  updatedAt: string;
  publishedAt?: string;
  
  // 用户信息
  createdBy: string;
  createdByName: string;
  updatedBy: string;
  updatedByName: string;
  
  // 元数据
  metadata: {
    width: number;
    height: number;
    totalDuration: number;
    pageCount: number;
    objectCount: number;
  };
  
  // 缩略图
  thumbnail?: string;     // 缩略图URL
}

ApiResponse<{
  items: ProgramListItem[];
}>
```

#### 2.7 删除节目
```http
DELETE /core/api/programs/{programId}
```

**查询参数：**
```typescript
interface DeleteProgramParams {
  force?: boolean;        // 强制删除（包括已发布的）
}
```

**响应：**
```typescript
ApiResponse<{
  deleted: boolean;
  affectedVersions: string[]; // 被删除的版本列表
}>
```

#### 2.8 复制节目
```http
POST /core/api/programs/{programId}/duplicate
```

**请求体：**
```typescript
interface DuplicateProgramRequest {
  newName: string;
  copyMaterials?: boolean; // 是否复制素材引用
}
```

**响应：**
```typescript
ApiResponse<{
  newProgramId: string;
  newName: string;
}>
```

### 3. 系统配置API

#### 3.1 获取系统字体列表
```http
GET /core/api/system/fonts
```

**响应：**
```typescript
interface SystemFont {
  family: string;         // 字体族名
  displayName: string;    // 显示名称
  category: 'serif' | 'sans-serif' | 'monospace' | 'cursive';
  isSystemFont: boolean;  // 是否系统字体
  previewUrl?: string;    // 预览图URL
}

ApiResponse<SystemFont[]>
```

#### 3.2 获取颜色预设
```http
GET /core/api/system/color-presets
```

**响应：**
```typescript
interface ColorPreset {
  name: string;           // 预设名称
  colors: string[];       // 颜色数组
  category: 'basic' | 'theme' | 'gradient';
}

ApiResponse<ColorPreset[]>
```

#### 3.3 获取节目模板
```http
GET /core/api/system/templates
```

**响应：**
```typescript
interface ProgramTemplate {
  id: string;
  name: string;
  description: string;
  category: string;
  thumbnail: string;
  dimensions: { width: number; height: number };
  previewUrl?: string;    // 预览URL
  isBuiltIn: boolean;     // 是否内置模板
}

ApiResponse<ProgramTemplate[]>
```

---

## 错误处理规范

### 错误代码定义

```typescript
enum ApiErrorCode {
  // 通用错误 (1000-1999)
  INVALID_REQUEST = 'ERR_1001',
  UNAUTHORIZED = 'ERR_1002',
  FORBIDDEN = 'ERR_1003',
  NOT_FOUND = 'ERR_1004',
  INTERNAL_ERROR = 'ERR_1500',
  
  // 素材相关错误 (2000-2999)
  MATERIAL_NOT_FOUND = 'ERR_2001',
  MATERIAL_UPLOAD_FAILED = 'ERR_2002',
  MATERIAL_FORMAT_UNSUPPORTED = 'ERR_2003',
  MATERIAL_SIZE_EXCEEDED = 'ERR_2004',
  MATERIAL_PROCESSING_FAILED = 'ERR_2005',
  MATERIAL_ACCESS_DENIED = 'ERR_2006',
  
  // 节目相关错误 (3000-3999)
  PROGRAM_NOT_FOUND = 'ERR_3001',
  PROGRAM_SAVE_FAILED = 'ERR_3002',
  PROGRAM_VSN_INVALID = 'ERR_3003',
  PROGRAM_PUBLISH_FAILED = 'ERR_3004',
  PROGRAM_VERSION_CONFLICT = 'ERR_3005',
  PROGRAM_MATERIAL_MISSING = 'ERR_3006',
  
  // VSN验证错误 (4000-4999)
  VSN_MISSING_REQUIRED_FIELD = 'ERR_4001',
  VSN_INVALID_DATA_TYPE = 'ERR_4002',
  VSN_INVALID_BUSINESS_RULE = 'ERR_4003',
  VSN_CONVERSION_FAILED = 'ERR_4004',
}
```

### 错误响应示例

```typescript
// 素材不存在
{
  "success": false,
  "error": {
    "code": "ERR_2001",
    "message": "素材不存在或已被删除",
    "details": {
      "materialId": "mat_123456",
      "requestedAt": "2024-01-15T10:30:00Z"
    }
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00Z"
  }
}

// VSN验证失败
{
  "success": false,
  "error": {
    "code": "ERR_4001",
    "message": "VSN格式验证失败",
    "details": {
      "validationErrors": [
        {
          "field": "pages[0].regions[0].rect.x",
          "message": "X坐标不能为空",
          "code": "REQUIRED_FIELD_MISSING"
        },
        {
          "field": "pages[0].loopType",
          "message": "当LoopType为0时，AppointDuration必须指定",
          "code": "BUSINESS_RULE_VIOLATION"
        }
      ]
    }
  }
}
```

---

## 认证和权限

### 认证方式
- 使用现有的OAuth2 + Cookie认证系统
- 所有API请求都通过网关统一处理认证
- 前端无需额外处理认证逻辑

### 权限控制

#### 节目权限
```typescript
enum ProgramPermission {
  CREATE = 'program:create',      // 创建节目
  READ = 'program:read',          // 查看节目
  UPDATE = 'program:update',      // 编辑节目
  DELETE = 'program:delete',      // 删除节目
  PUBLISH = 'program:publish',    // 发布节目
}
```

#### 素材权限
```typescript
enum MaterialPermission {
  UPLOAD = 'material:upload',     // 上传素材
  READ = 'material:read',         // 查看素材
  DELETE = 'material:delete',     // 删除素材
  MANAGE = 'material:manage',     // 管理素材（分类、标签等）
}
```

### 数据隔离
- 用户只能访问自己创建的节目和有权限的素材
- 管理员可以访问所有数据
- 支持团队协作（共享节目和素材）

---

## 性能和缓存策略

### 缓存策略

#### 素材缓存
- **素材列表**：Redis缓存30分钟，支持标签失效
- **素材详情**：Redis缓存1小时，文件变更时失效
- **素材文件**：CDN缓存，永久有效（基于MD5）

#### 节目缓存
- **节目列表**：Redis缓存10分钟
- **节目详情**：Redis缓存30分钟，保存时失效
- **VSN转换结果**：Redis缓存1小时，内容变更时失效

### 性能优化

#### 分页和懒加载
```typescript
// 推荐的分页参数
const DEFAULT_PAGE_SIZE = 20;
const MAX_PAGE_SIZE = 100;

// 素材列表支持懒加载
interface MaterialListResponse {
  items: MaterialInfo[];
  hasMore: boolean;       // 是否有更多数据
  nextCursor?: string;    // 游标分页支持
}
```

#### 大文件处理
- 素材上传支持分片上传
- 大型节目支持增量保存
- VSN转换支持异步处理

#### 并发控制
```typescript
// 节目编辑锁定机制
interface ProgramLock {
  programId: string;
  lockedBy: string;       // 锁定用户ID
  lockedAt: string;       // 锁定时间
  expiresAt: string;      // 过期时间
  lockType: 'edit' | 'publish'; // 锁定类型
}
```

---

## 部署和配置

### 环境变量配置

```bash
# 素材存储配置
MATERIAL_STORAGE_TYPE=local|s3|oss    # 存储类型
MATERIAL_STORAGE_PATH=/uploads        # 本地存储路径
MATERIAL_MAX_FILE_SIZE=100MB          # 最大文件大小
MATERIAL_ALLOWED_TYPES=jpg,png,mp4,gif # 允许的文件类型

# VSN转换配置
VSN_VALIDATION_STRICT=true            # 是否启用严格验证
VSN_XML_ENCODING=UTF-8               # XML编码格式

# 缓存配置
REDIS_URL=redis://localhost:6379     # Redis连接
CACHE_DEFAULT_TTL=1800               # 默认缓存时间（秒）

# 性能配置
MAX_CONCURRENT_UPLOADS=10            # 最大并发上传数
MAX_CONCURRENT_VSN_CONVERSIONS=5    # 最大并发VSN转换数
```

### 数据库表结构

#### programs 表
```sql
CREATE TABLE programs (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  status ENUM('draft', 'published') DEFAULT 'draft',
  version VARCHAR(20) NOT NULL,
  
  -- 尺寸信息
  width INT NOT NULL,
  height INT NOT NULL,
  
  -- 时间信息
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  published_at TIMESTAMP NULL,
  
  -- 用户信息
  created_by VARCHAR(36) NOT NULL,
  updated_by VARCHAR(36) NOT NULL,
  
  -- 元数据（JSON）
  metadata JSON,
  
  INDEX idx_status (status),
  INDEX idx_created_by (created_by),
  INDEX idx_created_at (created_at)
);
```

#### program_content 表（MongoDB）
```javascript
// MongoDB集合：program_content
{
  _id: ObjectId,
  programId: String,      // 关联programs表
  version: String,
  editorState: Object,    // EditorState JSON
  vsnData: Object,        // VSNData JSON
  materialRefs: Array,    // MaterialReference数组
  createdAt: Date,
  updatedAt: Date
}

// 索引
db.program_content.createIndex({ programId: 1, version: 1 }, { unique: true })
db.program_content.createIndex({ programId: 1, updatedAt: -1 })
```

#### materials 表
```sql
CREATE TABLE materials (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  type INT NOT NULL,                    -- VSN素材类型
  category VARCHAR(50) NOT NULL,       -- 分类标识
  
  -- 文件信息
  file_path VARCHAR(500) NOT NULL,
  access_url VARCHAR(500) NOT NULL,
  md5_hash VARCHAR(32) NOT NULL,
  origin_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  
  -- 元数据（JSON）
  metadata JSON,
  
  -- 状态信息
  status ENUM('processing', 'ready', 'error') DEFAULT 'processing',
  processing_progress TINYINT DEFAULT 0,
  error_message TEXT NULL,
  
  -- 管理信息
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by VARCHAR(36) NOT NULL,
  tags JSON,                           -- 标签数组
  description TEXT,
  
  INDEX idx_type_category (type, category),
  INDEX idx_status (status),
  INDEX idx_created_by (created_by),
  INDEX idx_md5_hash (md5_hash),
  FULLTEXT idx_search (name, description)
);
```

---

## 测试要求

### 单元测试覆盖

#### API接口测试
- 所有API接口的正常流程测试
- 参数验证测试（必填、类型、范围等）
- 权限控制测试
- 错误处理测试

#### 数据转换测试
```typescript
// VSN转换测试用例
describe('VSN Converter', () => {
  test('should convert EditorState to valid VSN format', () => {
    const editorState = createTestEditorState();
    const vsnData = convertToVSN(editorState);
    
    expect(validateVSNData(vsnData)).toEqual({
      isValid: true,
      errors: []
    });
  });
  
  test('should handle missing required fields', () => {
    const invalidEditorState = createInvalidEditorState();
    const result = convertToVSN(invalidEditorState);
    
    expect(result.validation.isValid).toBe(false);
    expect(result.validation.errors).toContainEqual(
      expect.objectContaining({
        code: 'REQUIRED_FIELD_MISSING',
        field: 'pages[0].appointDuration'
      })
    );
  });
});
```

#### 性能测试
- 大文件上传性能测试
- 复杂节目加载性能测试
- 并发编辑压力测试
- VSN转换性能测试

### 集成测试

#### 端到端流程测试
1. 创建节目草稿
2. 上传和使用素材
3. 编辑和保存节目
4. VSN转换和验证
5. 发布节目

#### 数据一致性测试
- EditorState ↔ VSNData 转换一致性
- 素材引用完整性
- 版本管理一致性

### 测试数据

#### 标准测试数据集
```typescript
// 提供完整的测试数据
export const TEST_MATERIALS: MaterialInfo[] = [
  {
    id: 'mat_image_001',
    name: '测试图片.jpg',
    type: 2,
    category: 'image',
    // ... 完整的素材信息
  },
  // 更多测试素材...
];

export const TEST_EDITOR_STATE: EditorState = {
  program: { name: '测试节目', width: 1920, height: 1080 },
  pages: [/* 完整的页面数据 */],
  currentPageIndex: 0,
  canvasStates: {}
};
```

---

## 附录

### VSN格式关键约束总结

1. **必填字段强制性**：所有标记为"必填"的字段都必须有值
2. **数据类型要求**：所有数值必须转换为String类型
3. **业务规则验证**：
   - LoopType为"0"时，AppointDuration必须指定
   - Region的Rect必须包含完整的位置信息
   - LogFont的lfHeight字段是必需的
   - 同步窗口只能添加特定类型素材

### 常用VSN素材类型映射

| Type | 说明 | 前端Category | 必需属性 |
|------|------|-------------|----------|
| 2 | 图片 | image | type, fileSource, alpha |
| 3 | 视频 | video | type, fileSource |
| 4 | 单行文本 | text | type, text, textColor, logFont |
| 5 | 多行文本 | text | type, text, textColor, logFont |
| 6 | GIF | video | type, fileSource, playTimes, alpha |
| 9 | 普通时钟 | clock | type, duration, isAnalog, timezone |
| 14 | 气象 | sensor | type, duration, regionname, regioncode |
| 27 | 网页/流媒体 | web | type, url, duration, alpha |

---

**重要提醒**：本接口规范是前后端协作的基础文档，后端开发时请严格按照此规范实现。如有疑问或需要调整，请及时与前端团队沟通确认。